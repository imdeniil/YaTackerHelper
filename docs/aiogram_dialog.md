# aiogram-dialog: –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è

–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–µ—à–µ–Ω–∏—é —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π aiogram-dialog.

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

### [–†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-—Å–æ–æ–±—â–µ–Ω–∏—è–º–∏-1)
- [–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫–Ω–∞ –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á](#–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ-–æ–∫–Ω–∞-–¥–ª—è-—Ñ–æ–Ω–æ–≤—ã—Ö-–∑–∞–¥–∞—á)
- [–í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ –≤ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–∫–Ω–∞—Ö](#–≤–∞–ª–∏–¥–∞—Ü–∏—è-–≤–≤–æ–¥–∞-–≤-–¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö-–æ–∫–Ω–∞—Ö)
- [–ü—Ä–∏–≤—è–∑–∫–∞ DialogManager –∫ —Å–æ–æ–±—â–µ–Ω–∏—é](#–ø—Ä–∏–≤—è–∑–∫–∞-dialogmanager-–∫-—Å–æ–æ–±—â–µ–Ω–∏—é)

### [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫-1)
- [–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤—ã–µ –æ–∫–Ω–∞ (UnknownIntent)](#—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ-–¥–∏–∞–ª–æ–≥–æ–≤—ã–µ-–æ–∫–Ω–∞-unknownintent)
/
### [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-–ø–∞—Ç—Ç–µ—Ä–Ω—ã-1)
- [–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤](#–º–æ–¥—É–ª—å–Ω–∞—è-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–¥–∏–∞–ª–æ–≥–æ–≤)

### [–†–µ—Å—É—Ä—Å—ã](#—Ä–µ—Å—É—Ä—Å—ã-1)

---

## –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫–Ω–∞ –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Progress –≤–∏–¥–∂–µ—Ç–∞ —Å —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ–π, –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏ —á–µ—Ä–µ–∑ `switch_to()` —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ, –∑–∞—Å–æ—Ä—è—è —á–∞—Ç.

**–ü—Ä–∏—á–∏–Ω–∞:** aiogram-dialog –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏ (—Ä–∞–∑–Ω—ã–º–∏ State), —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ —Å —Ä–∞–∑–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

#### ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

```python
# –î–≤–∞ —Ä–∞–∑–Ω—ã—Ö –æ–∫–Ω–∞
confirm_window = Window(
    Const("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"),
    Button(Const("–ù–∞—á–∞—Ç—å"), id="start", on_click=on_start),
    state=MyState.confirm,
)

progress_window = Window(
    Const("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ..."),
    Progress("progress", 10),
    state=MyState.progress,  # ‚Üê –î—Ä—É–≥–æ–µ –æ–∫–Ω–æ
)

async def on_start(callback: CallbackQuery, button: Button, manager: DialogManager):
    await manager.switch_to(MyState.progress)  # ‚Üê –°–æ–∑–¥–∞—Å—Ç –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ
    bg = manager.bg()
    asyncio.create_task(background_task(bg))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ = –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

#### ‚úÖ –†–µ—à–µ–Ω–∏–µ: –û–¥–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ –æ–∫–Ω–æ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—ã–º–∏ —á–µ—Ä–µ–∑ —É—Å–ª–æ–≤–∏—è `when`.

```python
# –û–¥–Ω–æ –æ–∫–Ω–æ —Å —Ç—Ä–µ–º—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
task_window = Window(
    # –°–û–°–¢–û–Ø–ù–ò–ï 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (is_running=False, result=None)
    Const("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏", when=~F["is_running"] & ~F["result"]),
    Button(Const("–ù–∞—á–∞—Ç—å"), id="start", on_click=on_start,
           when=~F["is_running"] & ~F["result"]),

    # –°–û–°–¢–û–Ø–ù–ò–ï 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (is_running=True)
    Format("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: {phase}", when=F["is_running"]),
    Progress("progress", 10, when=F["is_running"]),

    # –°–û–°–¢–û–Ø–ù–ò–ï 3: –†–µ–∑—É–ª—å—Ç–∞—Ç (is_running=False, result=True)
    Const("–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", when=~F["is_running"] & F["result"]),
    Button(Const("–ó–∞–∫—Ä—ã—Ç—å"), id="close", on_click=on_close,
           when=~F["is_running"] & F["result"]),

    # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–±—Ä–æ—Å –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    MessageInput(on_message_during_task),

    state=MyState.task,  # ‚Üê –û–î–ù–û –æ–∫–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
    getter=get_task_data,
)
```

**Handler –∑–∞–ø—É—Å–∫–∞:**

```python
async def on_start(callback: CallbackQuery, button: Button, manager: DialogManager):
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    manager.dialog_data["is_running"] = True
    manager.dialog_data["progress"] = 0
    manager.dialog_data["phase"] = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..."

    # ‚ùå –ù–ï –¥–µ–ª–∞–µ–º switch_to()! –û—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Ç–æ–º –∂–µ –æ–∫–Ω–µ

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    bg = manager.bg()
    asyncio.create_task(background_task(bg))
```

**–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞:**

```python
async def background_task(manager: DialogManager):
    try:
        for i in range(100):
            # –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ manager.update()
            await manager.update({
                "is_running": True,
                "progress": i,
                "phase": f"–®–∞–≥ {i}/100",
            })
            await asyncio.sleep(0.1)

        # –ó–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        await manager.update({
            "is_running": False,
            "result": True,
        })
    except Exception as e:
        # –û—à–∏–±–∫–∞
        await manager.update({
            "is_running": False,
            "result": False,
            "error": str(e),
        })
```

**Data getter:**

```python
async def get_task_data(dialog_manager: DialogManager, **kwargs):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –æ–∫–Ω–∞."""
    return {
        # –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        "task_name": dialog_manager.dialog_data.get("task_name", ""),

        # –î–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        "is_running": dialog_manager.dialog_data.get("is_running", False),
        "progress": dialog_manager.dialog_data.get("progress", 0),
        "phase": dialog_manager.dialog_data.get("phase", ""),

        # –î–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        "result": dialog_manager.dialog_data.get("result"),
        "error": dialog_manager.dialog_data.get("error"),
    }
```

#### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π**, –µ—Å–ª–∏:
- –ù—É–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ real-time
- –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ)
- –ï—Å—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç

‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π**, –µ—Å–ª–∏:
- –û–∫–Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã (—Ä–∞–∑–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –º–µ–Ω—é)
- –ù–µ—Ç —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

#### –ß–µ–∫–ª–∏—Å—Ç

1. ‚òëÔ∏è –û–¥–Ω–æ –æ–∫–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
2. ‚òëÔ∏è –í–∏–¥–∂–µ—Ç—ã —Å —É—Å–ª–æ–≤–∏—è–º–∏ `when=F[...]`
3. ‚òëÔ∏è Getter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
4. ‚òëÔ∏è Handler –ù–ï –¥–µ–ª–∞–µ—Ç `switch_to()`
5. ‚òëÔ∏è –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `manager.update()`
6. ‚òëÔ∏è –§–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è (`is_running`, `result`) –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
7. ‚òëÔ∏è `MessageInput` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞

---

### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ –≤ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–∫–Ω–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ –≤ `MessageInput` —Ö–æ—á–µ—Ç—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤ —Ç–æ–º –∂–µ –¥–∏–∞–ª–æ–≥–æ–≤–æ–º –æ–∫–Ω–µ, –∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

#### ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

```python
async def on_text_input(message: Message, widget: MessageInput, manager: DialogManager):
    text = message.text.strip()

    if not text or len(text) > 100:
        # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥")
        return
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á–∞—Ç –∑–∞—Å–æ—Ä—è–µ—Ç—Å—è.

#### ‚úÖ –†–µ—à–µ–Ω–∏–µ: switch_to —Å ShowMode.EDIT

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫—É –≤ `dialog_data`, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `show_mode`, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

**Input handler:**

```python
async def on_text_input(message: Message, widget: MessageInput, manager: DialogManager):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    if not message.text:
        manager.dialog_data["error"] = "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç"
        manager.show_mode = ShowMode.EDIT
        await manager.switch_to(MyState.enter_text)  # ‚Üê –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¢–û –ñ–ï –æ–∫–Ω–æ
        return

    text = message.text.strip()

    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    if len(text) > 100:
        manager.dialog_data["error"] = "‚ùå –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤)"
        manager.show_mode = ShowMode.EDIT
        await manager.switch_to(MyState.enter_text)
        return

    # –£—Å–ø–µ—à–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    manager.dialog_data.pop("error", None)  # –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫—É
    manager.dialog_data["text"] = text
    manager.show_mode = ShowMode.EDIT
    await manager.switch_to(MyState.confirm)  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ
```

**Window definition:**

```python
enter_text_window = Window(
    Const("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤):"),

    # –í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å error)
    Format("\n{error}\n", when="error"),

    Cancel(Const("‚ùå –û—Ç–º–µ–Ω–∞")),
    MessageInput(on_text_input),
    state=MyState.enter_text,
    getter=get_enter_text_data,
)
```

**Data getter:**

```python
async def get_enter_text_data(dialog_manager: DialogManager, **kwargs):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–∫–Ω–∞ –≤–≤–æ–¥–∞"""
    return {
        "error": dialog_manager.dialog_data.get("error"),  # ‚Üê –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
    }
```

#### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. **`show_mode = ShowMode.EDIT`** - –≥–æ–≤–æ—Ä–∏—Ç aiogram-dialog —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **`switch_to(CURRENT_STATE)`** - –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –≤—ã–∑–≤–∞—Ç—å getter —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. **`Format("\n{error}\n", when="error")`** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ—à–∏–±–∫–∞ –µ—Å—Ç—å

#### –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# ‚ùå –ü—Ä–æ—Å—Ç–æ return
manager.dialog_data["error"] = "‚ùå –û—à–∏–±–∫–∞"
return  # –û–∫–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è

# ‚ùå manager.update()
await manager.update({})  # –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

# ‚ùå message.answer()
await message.answer("‚ùå –û—à–∏–±–∫–∞")  # –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

---

### –ü—Ä–∏–≤—è–∑–∫–∞ DialogManager –∫ —Å–æ–æ–±—â–µ–Ω–∏—é

**–ü—Ä–æ–±–ª–µ–º–∞:** `DialogManager` –∂—ë—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–æ–æ–±—â–µ–Ω–∏—é, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø—Ä–∏—à—ë–ª callback. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ "–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å" –µ–≥–æ –Ω–∞ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ–Ω –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ.

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å –∫–Ω–æ–ø–∫–æ–π "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é". –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ —Ö–æ—á–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –≤ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. –ù–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –º–µ–Ω—é (–∏—Å—á–µ–∑–∞–µ—Ç).

#### ‚ùå –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# ‚ùå –ü–æ–ø—ã—Ç–∫–∞ 1: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
sent_msg = await bot.send_message(chat_id, "–ú–µ–Ω—é...")
await cmd_start(sent_msg, dialog_manager)  # manager –≤—Å–µ –µ—â–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É

# ‚ùå –ü–æ–ø—ã—Ç–∫–∞ 2: BgManager
bg = dialog_manager.bg()  # bg –Ω–∞—Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É
await bg.start(MainMenu.main, show_mode=ShowMode.SEND)

# ‚ùå –ü–æ–ø—ã—Ç–∫–∞ 3: show_mode
await dialog_manager.start(MainMenu.main, show_mode=ShowMode.SEND)  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
```

#### ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–¥–≤—É—Ö—à–∞–≥–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥)

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π callback —Å –Ω–æ–≤—ã–º dialog_manager —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é –∫–Ω–æ–ø–∫—É.

**–®–∞–≥ 1: –ü–µ—Ä–≤—ã–π callback (–æ—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–µ)**

```python
@router.callback_query(F.data == "goto_menu_from_document")
async def on_goto_menu(callback: CallbackQuery, dialog_manager: DialogManager):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–µ"""

    # 1. –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞
    try:
        await callback.bot.edit_message_reply_markup(
            chat_id=callback.message.chat.id,
            message_id=callback.message.message_id,
            reply_markup=None
        )
    except Exception as e:
        logger.error(f"Error removing button: {e}")

    await callback.answer()

    # 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–µ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
    try:
        await dialog_manager.reset_stack()
    except Exception:
        pass

    # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ù–û–í–û–ô –∫–Ω–æ–ø–∫–æ–π
    # –≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –ù–û–í–´–ô callback —Å –ù–û–í–´–ú dialog_manager
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="üè† –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é",
            callback_data="open_menu_fresh"  # ‚Üê –ù–æ–≤—ã–π callback_data
        )]
    ])

    await callback.bot.send_message(
        chat_id=callback.message.chat.id,
        text="–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é:",
        reply_markup=keyboard
    )
```

**–®–∞–≥ 2: –í—Ç–æ—Ä–æ–π callback (–æ—Ç –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏)**

```python
@router.callback_query(F.data == "open_menu_fresh")
async def on_open_menu_fresh(callback: CallbackQuery, dialog_manager: DialogManager):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ - –ù–ï —Å–≤—è–∑–∞–Ω —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º"""
    await callback.answer()

    # ‚úÖ –≠—Ç–æ—Ç dialog_manager –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ù–û–í–û–ú–£ —Å–æ–æ–±—â–µ–Ω–∏—é
    # –ë—É–¥–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ï–ì–û, –∞ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç
    await dialog_manager.start(MainMenu.main, mode=StartMode.RESET_STACK)
```

#### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–µ—Ä–≤—ã–π callback** - —É–¥–∞–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É, —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π
2. **–í—Ç–æ—Ä–æ–π callback** - –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π `dialog_manager`, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
3. –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `.start()` —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç

#### –†–µ–∑—É–ª—å—Ç–∞—Ç

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–µ
2. ‚úÖ –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ
4. ‚úÖ –ü–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É
6. ‚úÖ –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –º–µ–Ω—é
7. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç—Å—è

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤—ã–µ –æ–∫–Ω–∞ (UnknownIntent)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∏–ª–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞, –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤ —Å—Ç–∞—Ä–æ–º –æ–∫–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `UnknownIntent`:

```
aiogram_dialog.api.exceptions.UnknownIntent: Context not found for intent id: 1ca1f9
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ MemoryStorage –∏ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ. –û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ middleware aiogram-dialog, –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏ update.

#### ‚ùå –ü–æ—á–µ–º—É Middleware –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï aiogram-dialog
class UnknownIntentMiddleware(BaseMiddleware):
    async def __call__(self, handler, event, data):
        try:
            return await handler(event, data)
        except UnknownIntent:  # ‚Üê –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç
            pass
```

**–ü—Ä–æ–±–ª–µ–º–∞:** aiogram-dialog middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ –≤–∞—à–µ–≥–æ, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –î–û –≤–∞—à–µ–≥–æ middleware.

#### ‚úÖ –†–µ—à–µ–Ω–∏–µ: Error Handler

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π error handler, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö middleware.

```python
from aiogram import Router
from aiogram.types import ErrorEvent, CallbackQuery
from aiogram_dialog.api.exceptions import UnknownIntent

unknown_intent_router = Router()

@unknown_intent_router.error()
async def handle_unknown_intent(event: ErrorEvent):
    """Error handler –¥–ª—è UnknownIntent –∏—Å–∫–ª—é—á–µ–Ω–∏–π"""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    if not isinstance(event.exception, UnknownIntent):
        return

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ callback query
    if not isinstance(event.update.callback_query, CallbackQuery):
        return

    callback = event.update.callback_query

    try:
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
        await callback.message.delete()
    except Exception:
        pass

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await callback.message.answer(
        "‚ö†Ô∏è <b>–≠—Ç–æ –æ–∫–Ω–æ —É—Å—Ç–∞—Ä–µ–ª–æ</b>\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."
    )

    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback (—É–±–∏—Ä–∞–µ–º "—á–∞—Å–∏–∫–∏")
    await callback.answer("–û–∫–Ω–æ —É—Å—Ç–∞—Ä–µ–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start")

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º True - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
    return True
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**

```python
from bot.middlewares import unknown_intent_router

async def main():
    # Error handler –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º
    dp.include_router(unknown_intent_router)
    dp.include_router(commands_router)
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã
```

#### –ü–æ—á–µ–º—É Error Handler?

1. **–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –ª–æ–≤–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö middleware
3. **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True** - –ø–æ–º–µ—á–∞–µ—Ç –æ—à–∏–±–∫—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

### –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–æ–∂–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –≤—ã—Ä–∞—Å—Ç–∞—é—Ç –¥–æ 400-800+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–º–µ—à–∞–Ω—ã: data getters, button handlers, window definitions. –°–ª–æ–∂–Ω–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å.

#### ‚ùå –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Ñ–∞–π–ª

```python
# dialog.py - 700+ —Å—Ç—Ä–æ–∫
# - 2 data getters
# - 14 button handlers
# - 3 window definitions
# - Constants
# –í—Å—ë –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ!
```

#### ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –†–∞–∑–±–∏–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

```
dialogs/
‚îî‚îÄ‚îÄ my_dialog/              # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
    ‚îú‚îÄ‚îÄ __init__.py         # –≠–∫—Å–ø–æ—Ä—Ç –¥–∏–∞–ª–æ–≥–∞
    ‚îú‚îÄ‚îÄ constants.py        # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    ‚îú‚îÄ‚îÄ getters.py          # Data getters
    ‚îú‚îÄ‚îÄ handlers.py         # Button/input handlers
    ‚îî‚îÄ‚îÄ windows.py          # Window definitions
```

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

**1. `constants.py` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

–°–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, —Å–ª–æ–≤–∞—Ä–∏ –º–∞–ø–ø–∏–Ω–≥–æ–≤, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

```python
"""–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–∏–∞–ª–æ–≥–∞"""

# –°–ª–æ–≤–∞—Ä–∏-–º–∞–ø–ø–∏–Ω–≥–∏
STATUS_EMOJI = {
    "pending": "‚è≥",
    "active": "üîÑ",
    "completed": "‚úÖ",
}

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
def format_status(status: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    return STATUS_EMOJI.get(status, "‚ùì") + " " + status.title()
```

**–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å:**
- ‚úÖ –ï—Å—Ç—å —Å–ª–æ–≤–∞—Ä–∏-–º–∞–ø–ø–∏–Ω–≥–∏ (—Å—Ç–∞—Ç—É—Å—ã, —Ä–æ–ª–∏, —Ç–∏–ø—ã)
- ‚úÖ –ï—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
- ‚ùå –ù–µ—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏–ª–∏ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ

**2. `getters.py`**

–°–æ–¥–µ—Ä–∂–∏—Ç data getter —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–∫–æ–Ω.

```python
"""Data getters –¥–∏–∞–ª–æ–≥–∞"""

from typing import Any
from aiogram_dialog import DialogManager

async def get_list_data(dialog_manager: DialogManager, **kwargs) -> dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤"""
    return {
        "items": [],
        "count": 0,
    }

async def get_details_data(dialog_manager: DialogManager, **kwargs) -> dict[str, Any]:
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞"""
    item_id = dialog_manager.dialog_data.get("selected_item_id")
    return {
        "id": item_id,
        "name": "Element",
    }
```

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ö–∞–∂–¥—ã–π getter = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
- –ù–∞–∑–≤–∞–Ω–∏–µ: `get_<window_name>_data`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `dict[str, Any]`

**3. `handlers.py`**

–°–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏ input handlers.

```python
"""Handlers –¥–∏–∞–ª–æ–≥–∞"""

from aiogram.types import CallbackQuery, Message
from aiogram_dialog import DialogManager, ShowMode
from aiogram_dialog.widgets.kbd import Button, Select
from aiogram_dialog.widgets.input import MessageInput

# ============ Filter Handlers ============

async def on_filter_active(callback: CallbackQuery, button: Button, manager: DialogManager):
    """–§–∏–ª—å—Ç—Ä: –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã"""
    manager.dialog_data["filter"] = "active"
    await manager.update({})

# ============ Selection Handlers ============

async def on_item_selected(callback: CallbackQuery, widget: Select, manager: DialogManager, item_id: str):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞"""
    manager.dialog_data["selected_item_id"] = int(item_id)
    manager.show_mode = ShowMode.EDIT
    await manager.switch_to(MyState.view_details)

# ============ Input Handlers ============

async def on_text_input(message: Message, widget: MessageInput, manager: DialogManager):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞"""
    text = message.text.strip()
    if not text:
        manager.dialog_data["error"] = "‚ùå –¢–µ–∫—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
        manager.show_mode = ShowMode.EDIT
        await manager.switch_to(MyState.enter_text)
        return

    manager.dialog_data["text"] = text
    await manager.switch_to(MyState.confirm)
```

**–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:**
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
- –õ–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫: –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –∫ —Å–ª–æ–∂–Ω—ã–º

**4. `windows.py`**

–°–æ–¥–µ—Ä–∂–∏—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–∫–æ–Ω (Window).

```python
"""Window definitions –¥–∏–∞–ª–æ–≥–∞"""

from aiogram_dialog import Window
from aiogram_dialog.widgets.kbd import Button, Cancel, ScrollingGroup, Select
from aiogram_dialog.widgets.text import Const, Format

from .getters import get_list_data, get_details_data
from .handlers import on_filter_active, on_item_selected

# –û–∫–Ω–æ 1: –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
list_window = Window(
    Const("üìã <b>–°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤</b>\n"),
    Format("–í—Å–µ–≥–æ: {count}", when="count"),

    ScrollingGroup(
        Select(
            Format("{item[name]}"),
            id="item_select",
            item_id_getter=lambda x: str(x["id"]),
            items="items",
            on_click=on_item_selected,
        ),
        id="items_scroll",
        width=1,
        height=6,
        when="count",
    ),

    Button(Const("üîÑ –ê–∫—Ç–∏–≤–Ω—ã–µ"), id="filter_active", on_click=on_filter_active),
    Cancel(Const("üè† –ú–µ–Ω—é")),
    state=MyState.list,
    getter=get_list_data,
)

# –û–∫–Ω–æ 2: –î–µ—Ç–∞–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
details_window = Window(
    Format("üìÑ <b>–≠–ª–µ–º–µ–Ω—Ç #{id}</b>\n\n<b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {name}"),
    Button(Const("‚¨ÖÔ∏è –ù–∞–∑–∞–¥"), id="back", on_click=on_back),
    state=MyState.details,
    getter=get_details_data,
)
```

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (`.getters`, `.handlers`)
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–µ—Ä–µ–¥ –æ–∫–Ω–∞–º–∏: `# –û–∫–Ω–æ N: –û–ø–∏—Å–∞–Ω–∏–µ`
- –õ–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ –æ–∫–æ–Ω

**5. `__init__.py`**

–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≥–æ—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.

```python
"""–î–∏–∞–ª–æ–≥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏

–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞.
"""

from aiogram_dialog import Dialog
from .windows import list_window, details_window

my_dialog = Dialog(
    list_window,
    details_window,
)

__all__ = ["my_dialog"]
```

**–ü—Ä–∞–≤–∏–ª–∞:**
- Docstring –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- –ò–º–ø–æ—Ä—Ç –æ–∫–æ–Ω –∏–∑ `windows.py`
- –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ `__all__`

#### –ü—Ä–∏–º–µ—Ä—ã —Å—Ç—Ä—É–∫—Ç—É—Ä

**–ü—Ä–æ—Å—Ç–æ–π –¥–∏–∞–ª–æ–≥ (4 —Ñ–∞–π–ª–∞):**
```
my_dialog/
‚îú‚îÄ‚îÄ __init__.py    # 20 —Å—Ç—Ä–æ–∫
‚îú‚îÄ‚îÄ getters.py     # 50 —Å—Ç—Ä–æ–∫ - 3 getters
‚îú‚îÄ‚îÄ handlers.py    # 80 —Å—Ç—Ä–æ–∫ - 5 handlers
‚îî‚îÄ‚îÄ windows.py     # 60 —Å—Ç—Ä–æ–∫ - 3 –æ–∫–Ω–∞
```

**–°–ª–æ–∂–Ω—ã–π –¥–∏–∞–ª–æ–≥ (5 —Ñ–∞–π–ª–æ–≤):**
```
my_dialog/
‚îú‚îÄ‚îÄ __init__.py     # 20 —Å—Ç—Ä–æ–∫
‚îú‚îÄ‚îÄ constants.py    # 40 —Å—Ç—Ä–æ–∫ - STATUS_EMOJI, —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ getters.py      # 100 —Å—Ç—Ä–æ–∫ - 5 getters
‚îú‚îÄ‚îÄ handlers.py     # 200 —Å—Ç—Ä–æ–∫ - 12 handlers
‚îî‚îÄ‚îÄ windows.py      # 150 —Å—Ç—Ä–æ–∫ - 5 –æ–∫–æ–Ω
```

**Single window –¥–∏–∞–ª–æ–≥ (5 —Ñ–∞–π–ª–æ–≤):**
```
my_dialog/
‚îú‚îÄ‚îÄ __init__.py     # 20 —Å—Ç—Ä–æ–∫
‚îú‚îÄ‚îÄ constants.py    # 30 —Å—Ç—Ä–æ–∫ - –º–∞–ø–ø–∏–Ω–≥–∏
‚îú‚îÄ‚îÄ getters.py      # 80 —Å—Ç—Ä–æ–∫ - 1 –±–æ–ª—å—à–æ–π getter
‚îú‚îÄ‚îÄ handlers.py     # 150 —Å—Ç—Ä–æ–∫ - 10 handlers
‚îî‚îÄ‚îÄ windows.py      # 200 —Å—Ç—Ä–æ–∫ - 1 –æ–∫–Ω–æ —Å —Ä–µ–∂–∏–º–∞–º–∏
```

#### –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π**, –µ—Å–ª–∏:
- –î–∏–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç 3+ –æ–∫–Ω–∞
- –§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç 200-300 —Å—Ç—Ä–æ–∫
- –ë–æ–ª–µ–µ 5 button/input handlers
- –ï—Å—Ç—å —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ

‚ùå **–û—Å—Ç–∞–≤—å –º–æ–Ω–æ–ª–∏—Ç**, –µ—Å–ª–∏:
- 1-2 –ø—Ä–æ—Å—Ç—ã—Ö –æ–∫–Ω–∞
- –ú–µ–Ω–µ–µ 150 —Å—Ç—Ä–æ–∫
- 2-3 –ø—Ä–æ—Å—Ç—ã—Ö handlers
- –ù–µ—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç

#### –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

1. –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –∏–º–µ–Ω–µ–º –¥–∏–∞–ª–æ–≥–∞
2. –°–æ–∑–¥–∞—Ç—å `constants.py` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) - –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–∞–ø–ø–∏–Ω–≥–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
3. –°–æ–∑–¥–∞—Ç—å `getters.py` - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ data getters
4. –°–æ–∑–¥–∞—Ç—å `handlers.py` - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å handlers, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å
5. –°–æ–∑–¥–∞—Ç—å `windows.py` - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Window definitions
6. –°–æ–∑–¥–∞—Ç—å `__init__.py` - –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–∫–Ω–∞, —Å–æ–∑–¥–∞—Ç—å Dialog
7. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª
8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: `python -m py_compile file.py`

#### –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

- ‚òëÔ∏è –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚òëÔ∏è –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
- ‚òëÔ∏è –°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω
- ‚òëÔ∏è –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω
- ‚òëÔ∏è –î–∏–∞–ª–æ–≥ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `__all__`
- ‚òëÔ∏è Docstring –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- ‚òëÔ∏è –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –≤ handlers
- ‚òëÔ∏è –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–µ—Ä–µ–¥ –æ–∫–Ω–∞–º–∏

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
2. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã
3. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –æ–∫–Ω–∞

---

## –†–µ—Å—É—Ä—Å—ã

### –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [aiogram-dialog Documentation](https://aiogram-dialog.readthedocs.io/)
- [Progress Widget](https://aiogram-dialog.readthedocs.io/en/stable/widgets/text/progress/)
- [Background Manager](https://aiogram-dialog.readthedocs.io/en/stable/faq.html)

### –ü–æ–ª–µ–∑–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫–Ω–∞** - –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á —Å real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º** - –¥–ª—è –æ—à–∏–±–æ–∫ –≤–≤–æ–¥–∞ –±–µ–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞** - –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∫–∏ DialogManager
- **Error Handler** - –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ UnknownIntent
- **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** - –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤

### –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫–Ω–∞ –≤–º–µ—Å—Ç–æ `switch_to()` –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
2. –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –≤–≤–æ–¥ —á–µ—Ä–µ–∑ `switch_to(CURRENT_STATE)` —Å `ShowMode.EDIT`
3. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–æ–≤—ã–π callback –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ DialogManager
4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ UnknownIntent —á–µ—Ä–µ–∑ Error Handler, –∞ –Ω–µ Middleware
5. –†–∞–∑–±–∏–≤–∞–π—Ç–µ –¥–∏–∞–ª–æ–≥–∏ –Ω–∞ –º–æ–¥—É–ª–∏ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 200-300 —Å—Ç—Ä–æ–∫
