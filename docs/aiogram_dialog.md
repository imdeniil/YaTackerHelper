# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å aiogram-dialog

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ aiogram-dialog, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–º –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

---

## –ü—Ä–æ–±–ª–µ–º–∞: Progress –≤–∏–¥–∂–µ—Ç –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

### ‚ùå –°–∏–º–ø—Ç–æ–º—ã

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Progress –≤–∏–¥–∂–µ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏ —á–µ—Ä–µ–∑ `switch_to()`:

1. **–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
   - –ü—Ä–∏ `switch_to()` –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏ Telegram —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   - Progress –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –Ω–æ –∫–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ = –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   - –ß–∞—Ç –∑–∞—Å–æ—Ä—è–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º

2. **BgManager –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `bg.start()` —Å —Ä–∞–∑–Ω—ã–º–∏ `stack_id` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–∞–º:
     - `IncorrectBackgroundError` - –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `manager.dialog_data`
     - `UnknownIntent` - –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
   - UI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ –ø–æ–∫–∞–∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

### üîç –ü—Ä–∏—á–∏–Ω–∞

**–ö–ª—é—á–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** `switch_to()` –º–µ–∂–¥—É **—Ä–∞–∑–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏** –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
await manager.switch_to(CloneProject.progress)  # –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥–æ–µ –æ–∫–Ω–æ
# Telegram –æ—Ç–ø—Ä–∞–≤–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–∫–Ω–æ–º progress
```

aiogram-dialog **–Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ** –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ State —Å —Ä–∞–∑–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ (–ü–æ–¥—Ö–æ–¥ 9)

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ù–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏!** –û—Å—Ç–∞—Ç—å—Å—è –Ω–∞ –æ–¥–Ω–æ–º –æ–∫–Ω–µ –∏ –º–µ–Ω—è—Ç—å –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–µ—Ä–µ–∑ —É—Å–ª–æ–≤–∏—è `when`.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–û–¥–Ω–æ –æ–∫–Ω–æ —Å **—Ç—Ä–µ–º—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏**:

```python
Window(
    # === –°–û–°–¢–û–Ø–ù–ò–ï 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ===
    Const("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", when=~F["is_running"] & ~F["result"]),
    Button(..., when=~F["is_running"] & ~F["result"]),

    # === –°–û–°–¢–û–Ø–ù–ò–ï 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (Progress) ===
    Const("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...", when=F["is_running"]),
    Progress("progress", 10, when=F["is_running"]),

    # === –°–û–°–¢–û–Ø–ù–ò–ï 3: –†–µ–∑—É–ª—å—Ç–∞—Ç ===
    Const("–ó–∞–≤–µ—Ä—à–µ–Ω–æ!", when=~F["is_running"] & F["result"]),
    Button(..., when=~F["is_running"] & F["result"]),

    state=MyState.main,  # ‚Üê –û–î–ù–û –æ–∫–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
    getter=get_dynamic_data,
)
```

### –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã

1. **Handler –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É**
   ```python
   async def on_start_task(callback: CallbackQuery, button: Button, manager: DialogManager):
       # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
       manager.dialog_data["is_running"] = True
       manager.dialog_data["progress"] = 0

       # ‚ùå –ù–ï –¥–µ–ª–∞–µ–º switch_to! –û—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Ç–æ–º –∂–µ –æ–∫–Ω–µ
       # await manager.switch_to(MyState.progress)  # ‚Üê –£–ë–†–ê–õ–ò

       # –°–æ–∑–¥–∞—ë–º BgManager
       bg = manager.bg()

       # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
       asyncio.create_task(background_task(bg))
   ```

2. **–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ**
   ```python
   async def background_task(manager: DialogManager):
       for i in range(100):
           # –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ manager.update()
           await manager.update({
               "is_running": True,
               "progress": i,
           })
           await asyncio.sleep(0.1)

       # –ó–∞–≤–µ—Ä—à–µ–Ω–æ
       await manager.update({
           "is_running": False,
           "result": "–£—Å–ø–µ—à–Ω–æ",
       })
   ```

3. **–û–∫–Ω–æ —Å–∞–º–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è**
   - –ü—Ä–∏ `is_running = True` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è Progress
   - –ü—Ä–∏ `is_running = False` –∏ `result` –µ—Å—Ç—å ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - **–°–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è**, –∞ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–æ–µ!

### Getter

```python
async def get_dynamic_data(dialog_manager: DialogManager, **kwargs):
    """Getter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π."""
    return {
        # –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        "task_name": dialog_manager.dialog_data.get("task_name", ""),

        # –î–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        "is_running": dialog_manager.dialog_data.get("is_running", False),
        "progress": dialog_manager.dialog_data.get("progress", 0),

        # –î–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        "result": dialog_manager.dialog_data.get("result"),
        "error": dialog_manager.dialog_data.get("error"),
    }
```

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –§–∞–π–ª: `bot/dialogs/clone_project.py`

**–û–∫–Ω–æ `confirm_clone`** –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ç—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

```python
Window(
    # === –°–û–°–¢–û–Ø–ù–ò–ï 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (is_cloning=False, result=None) ===
    Format("üìÅ –ò—Å—Ö–æ–¥–Ω—ã–π –ø—Ä–æ–µ–∫—Ç: <b>{project_name}</b>", when=~F["is_cloning"] & ~F["result"]),
    Format("üìù –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: <b>{new_name}</b>", when=~F["is_cloning"] & ~F["result"]),
    Format("üìÆ –û—á–µ—Ä–µ–¥—å: <b>{queue}</b>\n", when=~F["is_cloning"] & ~F["result"]),
    Const("‚ö†Ô∏è –ù–∞—á–∞—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?", when=~F["is_cloning"] & ~F["result"]),
    Row(
        Button(Const("üöÄ –ù–∞—á–∞—Ç—å"), id="start_clone", on_click=on_start_clone,
               when=~F["is_cloning"] & ~F["result"]),
        Back(Const("‚óÄÔ∏è –ù–∞–∑–∞–¥"), when=~F["is_cloning"] & ~F["result"]),
    ),

    # === –°–û–°–¢–û–Ø–ù–ò–ï 2: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (is_cloning=True) ===
    Format("\n{phase}\n", when=F["is_cloning"]),
    Progress("progress", 10, when=F["is_cloning"]),

    # === –°–û–°–¢–û–Ø–ù–ò–ï 3: –†–µ–∑—É–ª—å—Ç–∞—Ç (is_cloning=False, result –µ—Å—Ç—å) ===
    Format("üìÅ –ü—Ä–æ–µ–∫—Ç: <b>{new_project_name}</b>", when=~F["is_cloning"] & F["result"]),
    Format("üìã –°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞—á: <b>{created_count}</b>\n", when=~F["is_cloning"] & F["result"]),
    Row(
        Url(Const("üîó –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç"), Format("{project_url}"),
            when=~F["is_cloning"] & F["result"]),
    ),
    Row(
        Cancel(Const("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"), when=~F["is_cloning"] & F["result"]),
    ),

    # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–±—Ä–æ—Å –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    MessageInput(on_message_during_clone),

    state=CloneProject.confirm_clone,  # ‚Üê –û–î–ù–û –æ–∫–Ω–æ
    getter=get_final_confirm_data,
)
```

**Handler –∑–∞–ø—É—Å–∫–∞:**

```python
async def on_start_clone(callback: CallbackQuery, button: Button, manager: DialogManager):
    """–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ–¥—Ö–æ–¥ 9: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ)."""
    project_id = manager.dialog_data.get("project_id")
    new_name = manager.dialog_data.get("new_name")
    queue = manager.dialog_data.get("queue")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    manager.dialog_data["is_cloning"] = True
    manager.dialog_data["progress"] = 0
    manager.dialog_data["phase"] = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..."

    # ‚ùå –ù–ï –¥–µ–ª–∞–µ–º switch_to! –û—Å—Ç–∞–µ–º—Å—è –Ω–∞ confirm_clone
    # await manager.switch_to(CloneProject.progress)  # ‚Üê –£–ë–†–ê–õ–ò

    # –°–æ–∑–¥–∞–µ–º BgManager –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    bg = manager.bg()

    # –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ —Å BgManager
    asyncio.create_task(
        clone_project_background_with_manager(
            manager=bg,
            project_id=project_id,
            new_name=new_name,
            queue=queue
        )
    )
```

**–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞:**

```python
async def clone_project_background_with_manager(
    manager: DialogManager,
    project_id: str,
    new_name: str,
    queue: str
):
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º BgManager."""
    try:
        async with TrackerClient() as tracker:
            cloner = ProjectCloner(tracker)

            # Callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            async def progress_update(value: float):
                total_progress = value * 0.5  # 0-50%
                phase = "üìÅ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..." if value <= 5 else "üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á..."

                # –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ manager.update()
                await manager.update({
                    "is_cloning": True,
                    "progress": int(total_progress),
                    "phase": phase,
                })

            cloner.set_progress_callback(progress_update)

            # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (0-50%)
            project_data = await cloner.fetch_project_data(project_id)

            # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (50-100%)
            async def clone_progress_update(value: float):
                total_progress = 50 + value * 0.5
                phase = "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á..."

                await manager.update({
                    "is_cloning": True,
                    "progress": int(total_progress),
                    "phase": phase,
                })

            cloner.set_progress_callback(clone_progress_update)
            result = await cloner.clone_project(
                project_data=project_data,
                new_project_name=new_name,
                target_queue=queue
            )

            # –ó–∞–≤–µ—Ä—à–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await manager.update({
                "is_cloning": False,
                "result": result.success,
                "new_project_name": result.new_project_name,
                "new_project_short_id": result.new_project_short_id,
                "created_count": len(result.new_issues_mapping),
                "project_url": f"https://tracker.yandex.ru/pages/projects/{result.new_project_short_id}",
            })

    except Exception as e:
        # –û—à–∏–±–∫–∞
        await manager.update({
            "is_cloning": False,
            "result": False,
            "error": str(e),
        })
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

### ‚úÖ –ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å

1. **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
   - –°–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
   - –ü–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
   - –ù–µ—Ç –ª–∏—à–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ BgManager**
   - –ù–µ –Ω—É–∂–µ–Ω –ø—Ä—è–º–æ–π Bot API (`bot.edit_message_text()`)
   - `manager.update()` –≤–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ú–µ–Ω—å—à–µ –∫–æ–¥–∞, –ø—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

3. **Progress –≤–∏–¥–∂–µ—Ç**
   - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥–∂–µ—Ç –≤–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π progress bar
   - –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤

4. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–¥–µ–æ–ª–æ–≥–∏–∏ aiogram-dialog
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `when` —É—Å–ª–æ–≤–∏–π –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –æ–∫–æ–Ω
   - –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –≤ getter

### ‚ö†Ô∏è –ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã

1. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –æ–∫–Ω–∞**
   - –ú–Ω–æ–≥–æ —É—Å–ª–æ–≤–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ —Å `when`
   - –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–µ–µ —á–∏—Ç–∞—Ç—å –∫–æ–¥

2. **Getter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö**
   - –ù—É–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
   - –ë–æ–ª—å—à–µ –ø–æ–ª–µ–π –≤ —Å–ª–æ–≤–∞—Ä–µ

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã (–ù–ï —Ä–∞–±–æ—Ç–∞—é—Ç)

### ‚ùå –ü–æ–¥—Ö–æ–¥ 1-8: switch_to() –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏

–í—Å–µ –ø–æ–¥—Ö–æ–¥—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `switch_to()` –º–µ–∂–¥—É `confirm` –∏ `progress` –æ–∫–Ω–∞–º–∏ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- –ü–æ–¥—Ö–æ–¥ 1: `switch_to + bg` –±–µ–∑ `stack_id`
- –ü–æ–¥—Ö–æ–¥ 2: `bg.start(RESET_STACK)`
- –ü–æ–¥—Ö–æ–¥ 3: `bg` —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º `stack_id`
- –ü–æ–¥—Ö–æ–¥ 4: `switch_to(EDIT) + bg` —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –ü–æ–¥—Ö–æ–¥ 5: `show_mode` –≤ getter
- –ü–æ–¥—Ö–æ–¥ 6: `done() -> bg.start()`
- –ü–æ–¥—Ö–æ–¥ 7: `update()` –≤–º–µ—Å—Ç–æ `switch_to` (–Ω–æ –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ–∫–Ω–µ)
- –ü–æ–¥—Ö–æ–¥ 8: —è–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `show_mode` –ø–µ—Ä–µ–¥ `bg`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏.

### ‚ùå –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Bot API

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `bot.edit_message_text()` –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ —ç—Ç–æ:
- –û–±—Ö–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã aiogram-dialog
- –†—É—á–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ UI
- –ë–æ–ª—å—à–µ –∫–æ–¥–∞
- –•—É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–í—ã–≤–æ–¥:** –ü–æ–¥—Ö–æ–¥ 9 (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ) - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

---

## –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π**, –µ—Å–ª–∏:
- –ù—É–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ real-time
- –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ)
- –ï—Å—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç

‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π**, –µ—Å–ª–∏:
- –û–∫–Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã (—Ä–∞–∑–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –º–µ–Ω—é)
- –ù–µ—Ç —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–∫–Ω–∞

1. ‚òëÔ∏è –û–¥–Ω–æ –æ–∫–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
2. ‚òëÔ∏è –í–∏–¥–∂–µ—Ç—ã —Å —É—Å–ª–æ–≤–∏—è–º–∏ `when=F[...]`
3. ‚òëÔ∏è Getter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
4. ‚òëÔ∏è Handler –ù–ï –¥–µ–ª–∞–µ—Ç `switch_to()`
5. ‚òëÔ∏è –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `manager.update()`
6. ‚òëÔ∏è –§–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è (`is_running`, `result`) –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
7. ‚òëÔ∏è `MessageInput` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–∫–æ–Ω (UnknownIntent)

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∏–ª–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤ —Å—Ç–∞—Ä–æ–º –¥–∏–∞–ª–æ–≥–æ–≤–æ–º –æ–∫–Ω–µ. aiogram-dialog –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `UnknownIntent`:

```
aiogram_dialog.api.exceptions.UnknownIntent: Context not found for intent id: 1ca1f9
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ MemoryStorage –∏ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- intent_id –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ middleware aiogram-dialog, –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏ update

### ‚úÖ –†–µ—à–µ–Ω–∏–µ: Error Handler

**–í–ê–ñ–ù–û:** Middleware –ù–ï –ø–æ–º–æ–∂–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ middleware aiogram-dialog, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ.

–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ - **–≥–ª–æ–±–∞–ª—å–Ω—ã–π error handler**:

```python
# bot/middlewares/unknown_intent.py
from aiogram import Router
from aiogram.types import ErrorEvent, CallbackQuery
from aiogram_dialog.api.exceptions import UnknownIntent

unknown_intent_router = Router()

@unknown_intent_router.error()
async def handle_unknown_intent(event: ErrorEvent):
    """Error handler –¥–ª—è UnknownIntent –∏—Å–∫–ª—é—á–µ–Ω–∏–π"""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ UnknownIntent –æ—à–∏–±–∫–∞
    if not isinstance(event.exception, UnknownIntent):
        return

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ callback query
    if not isinstance(event.update.callback_query, CallbackQuery):
        return

    callback = event.update.callback_query

    try:
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
        await callback.message.delete()
    except Exception:
        pass

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await callback.message.answer(
        "‚ö†Ô∏è <b>–≠—Ç–æ –æ–∫–Ω–æ —É—Å—Ç–∞—Ä–µ–ª–æ</b>\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."
    )

    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏" –≤ Telegram
    await callback.answer("–û–∫–Ω–æ —É—Å—Ç–∞—Ä–µ–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start")

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º True —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –æ—à–∏–±–∫—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
    return True
```

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ main.py

```python
from bot.middlewares import unknown_intent_router

async def main():
    # ...

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤
    dp.include_router(unknown_intent_router)  # Error handler –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º
    dp.include_router(commands_router)
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã
```

### –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ Error Handler?

1. **–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**
   - –õ–æ–≤–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
   - –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤ middleware aiogram-dialog
   - –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ middleware

2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**
   - Error handlers –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö middleware
   - –ú–æ–≥—É—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –ª—é–±–æ–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

3. **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True**
   - –ü–æ–º–µ—á–∞–µ—Ç –æ—à–∏–±–∫—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö –∫–∞–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

### ‚ùå –ü–æ—á–µ–º—É Middleware –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï aiogram-dialog middleware
class UnknownIntentMiddleware(BaseMiddleware):
    async def __call__(self, handler, event, data):
        try:
            return await handler(event, data)
        except UnknownIntent:  # ‚Üê –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç, –æ—à–∏–±–∫–∞ —Ä–∞–Ω—å—à–µ
            # ...
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- aiogram-dialog middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –î–û –≤–∞—à–µ–≥–æ middleware
- –û—à–∏–±–∫–∞ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ

- **Error handler:** `bot/middlewares/unknown_intent.py`
- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:** `main.py:129` (–ø–µ—Ä–≤—ã–π —Ä–æ—É—Ç–µ—Ä)
- **–≠–∫—Å–ø–æ—Ä—Ç:** `bot/middlewares/__init__.py`

---

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏

- [aiogram-dialog Documentation](https://aiogram-dialog.readthedocs.io/)
- [Progress Widget](https://aiogram-dialog.readthedocs.io/en/stable/widgets/text/progress/)
- [Background Manager](https://aiogram-dialog.readthedocs.io/en/stable/faq.html)
- –¢–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥: `bot/dialogs/test_progress_dialog.py`
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: `bot/dialogs/clone_project.py:737-789`

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2025-12-30
- –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–∫–æ–Ω (UnknownIntent)"
- –û–ø–∏—Å–∞–Ω–æ —Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Error Handler –≤–º–µ—Å—Ç–æ Middleware
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É middleware –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 2025-10-09
- –ü–µ—Ä–µ–ø–∏—Å–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É Progress –≤–∏–¥–∂–µ—Ç–∞
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞ 9 (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ)
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –£–±—Ä–∞–Ω—ã —Å—Ç–∞—Ä—ã–µ —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–æ BgManager (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

### 2025-10-08
- –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Bot API"
- –û–ø–∏—Å–∞–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å BgManager

### 2025-01-08
- –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
