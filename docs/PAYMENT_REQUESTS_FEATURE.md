# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–ø–ª–∞—Ç—É

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (Worker/Manager/Owner) —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏—Ö billing –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.

**–†–æ–ª–∏:**
- **Worker/Manager/Owner** - —Å–æ–∑–¥–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –∏—Ö —Å—Ç–∞—Ç—É—Å
- **Billing –∫–æ–Ω—Ç–∞–∫—Ç—ã** (`is_billing_contact=True`) - –¢–û–õ–¨–ö–û –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã (–ø–ª–∞–Ω–∏—Ä—É—é—Ç –æ–ø–ª–∞—Ç—É, –æ—Ç–º–µ—á–∞—é—Ç –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–µ), –ù–ï —Å–æ–∑–¥–∞—é—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `payment_requests`

```sql
- id: Integer (PK)
- created_by_id: FK -> users.id (—Å–æ–∑–¥–∞—Ç–µ–ª—å - Worker)
- title: String (–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞)
- amount: String (—Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö)
- comment: String (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
- invoice_file_id: String (Telegram file_id —Å—á–µ—Ç–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- status: Enum (PENDING, SCHEDULED_TODAY, SCHEDULED_DATE, PAID, CANCELLED)
- created_at: DateTime
- updated_at: DateTime
- processing_by_id: FK -> users.id (billing –∫–æ–Ω—Ç–∞–∫—Ç –≤–∑—è–≤—à–∏–π –≤ —Ä–∞–±–æ—Ç—É)
- paid_by_id: FK -> users.id (billing –∫–æ–Ω—Ç–∞–∫—Ç –æ–ø–ª–∞—Ç–∏–≤—à–∏–π)
- paid_at: DateTime (–¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã)
- scheduled_date: Date (–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã)
- payment_proof_file_id: String (Telegram file_id –ø–ª–∞—Ç–µ–∂–∫–∏)
- worker_message_id: BigInteger (ID —Å–æ–æ–±—â–µ–Ω–∏—è —É Worker –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
- billing_message_id: BigInteger (ID —Å–æ–æ–±—â–µ–Ω–∏—è —É billing –∫–æ–Ω—Ç–∞–∫—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
```

### Enum `PaymentRequestStatus`

```python
PENDING = "pending"              # ‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
SCHEDULED_TODAY = "scheduled_today"  # üìÖ –û–ø–ª–∞—á—É —Å–µ–≥–æ–¥–Ω—è
SCHEDULED_DATE = "scheduled_date"    # üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –¥–∞—Ç—É
PAID = "paid"                    # ‚úÖ –û–ø–ª–∞—á–µ–Ω–æ
CANCELLED = "cancelled"          # ‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ
```

## Workflow —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (Worker)

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞

**–î–∏–∞–ª–æ–≥:** `PaymentRequestCreation` (`bot/dialogs/payment_request.py`)

**–®–∞–≥–∏:**
1. **enter_title** - –í–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω–µ –ø—É—Å—Ç–æ–µ, –º–∞–∫—Å 200 —Å–∏–º–≤–æ–ª–æ–≤
2. **enter_amount** - –í–≤–æ–¥ —Å—É–º–º—ã –≤ —Ä—É–±–ª—è—Ö
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
3. **enter_comment** - –í–≤–æ–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω–µ –ø—É—Å—Ç–æ–µ, –º–∞–∫—Å 1000 —Å–∏–º–≤–æ–ª–æ–≤
4. **attach_invoice** - –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–Ω–µ —Ñ–æ—Ç–æ)
5. **confirm** - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:

1. **–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î** —Å —Å—Ç–∞—Ç—É—Å–æ–º `PENDING`
2. **–ü–æ–ª—É—á–∞—é—Ç—Å—è –≤—Å–µ billing –∫–æ–Ω—Ç–∞–∫—Ç—ã** (`is_billing_contact=True`)
3. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º billing –∫–æ–Ω—Ç–∞–∫—Ç–∞–º:**
   - –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–ø—Ä–æ—Å–∞
   - Inline –∫–Ω–æ–ø–∫–∏: "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ", "üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å", "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
   - –°—á–µ—Ç (–µ—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `billing_message_id` —É –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
4. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ Worker:**
   - –°–æ–æ–±—â–µ–Ω–∏–µ "–ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω"
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `worker_message_id` –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ (Billing –∫–æ–Ω—Ç–∞–∫—Ç)

### –§–∞–π–ª: `bot/handlers/payment_callbacks.py`

### –ö–Ω–æ–ø–∫–∞ "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ"

**Handler:** `on_payment_paid`

**Flow:**
1. –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ FSM state `UploadProof.waiting_for_document`
2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–ª–∞—Ç–µ–∂–∫–∏
3. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–Ω–µ —Ñ–æ—Ç–æ)
4. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å: `status=PAID`, `paid_by_id`, `paid_at`, `payment_proof_file_id`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —É billing –∫–æ–Ω—Ç–∞–∫—Ç–∞ (—É–±–∏—Ä–∞–µ—Ç –∫–Ω–æ–ø–∫–∏)
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Worker —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ø–ª–∞—Ç–µ–∂–∫–æ–π

**–û—Ç–º–µ–Ω–∞:** `/cancel`

### –ö–Ω–æ–ø–∫–∞ "üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"

**Handler:** `on_payment_schedule`

**–û–ø—Ü–∏–∏:**
1. **üìÖ –°–µ–≥–æ–¥–Ω—è** (`on_payment_schedule_today`)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å: `status=SCHEDULED_TODAY`, `processing_by_id`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —É billing –∫–æ–Ω—Ç–∞–∫—Ç–∞
   - –£–≤–µ–¥–æ–º–ª—è–µ—Ç Worker
   - TODO: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 18:00 –ú–°–ö

2. **üìÜ –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É** (`on_payment_schedule_date`)
   - –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ FSM state `SelectDate.waiting_for_date`
   - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–≤–æ–¥ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–î–î.–ú–ú.–ì–ì–ì–ì`
   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –¥–∞—Ç–∞ –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å: `status=SCHEDULED_DATE`, `processing_by_id`, `scheduled_date`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —É billing –∫–æ–Ω—Ç–∞–∫—Ç–∞
   - –£–≤–µ–¥–æ–º–ª—è–µ—Ç Worker
   - TODO: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 10:00 –ú–°–ö –≤ –¥–µ–Ω—å –æ–ø–ª–∞—Ç—ã

**–û—Ç–º–µ–Ω–∞:** `/cancel` –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∞"

### –ö–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"

**Handler:** `on_payment_cancel`

**Flow:**
- –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å: `status=CANCELLED`
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —É billing –∫–æ–Ω—Ç–∞–∫—Ç–∞ (—É–±–∏—Ä–∞–µ—Ç –∫–Ω–æ–ø–∫–∏)
- –£–≤–µ–¥–æ–º–ª—è–µ—Ç Worker –æ–± –æ—Ç–º–µ–Ω–µ

## –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### `format_payment_request_message`

–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `request_id` - ID –∑–∞–ø—Ä–æ—Å–∞
- `title` - –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞
- `amount` - –°—É–º–º–∞
- `comment` - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- `created_by_name` - –§–ò–û —Å–æ–∑–¥–∞—Ç–µ–ª—è
- `status` - –°—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞
- `created_at` - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- `processing_by_name` - –§–ò–û –≤–∑—è–≤—à–µ–≥–æ –≤ —Ä–∞–±–æ—Ç—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `scheduled_date` - –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `paid_by_name` - –§–ò–û –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `paid_at` - –î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
‚è≥ –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–ø–ª–∞—Ç—É #1

–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
–ù–∞–∑–≤–∞–Ω–∏–µ: –û–ø–ª–∞—Ç–∞ –∑–∞ –¥–∏–∑–∞–π–Ω –ª–æ–≥–æ—Ç–∏–ø–∞
–°—É–º–º–∞: 5000 ‚ÇΩ
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ê–≤–∞–Ω—Å 50%

–°–æ–∑–¥–∞–ª: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 30.12.2025 15:30
```

### `get_payment_request_keyboard`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞.

**–°—Ç–∞—Ç—É—Å—ã –∏ –∫–Ω–æ–ø–∫–∏:**

| –°—Ç–∞—Ç—É—Å | –ö–Ω–æ–ø–∫–∏ |
|--------|--------|
| PENDING | ‚úÖ –û–ø–ª–∞—á–µ–Ω–æ, üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å, ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å |
| SCHEDULED_TODAY | ‚úÖ –û–ø–ª–∞—á–µ–Ω–æ, ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å |
| SCHEDULED_DATE | ‚úÖ –û–ø–ª–∞—á–µ–Ω–æ, ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å |
| PAID | –ù–µ—Ç –∫–Ω–æ–ø–æ–∫ |
| CANCELLED | –ù–µ—Ç –∫–Ω–æ–ø–æ–∫ |

## CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

### –§–∞–π–ª: `bot/database/crud.py`

**–ö–ª–∞—Å—Å:** `PaymentRequestCRUD`

**–ú–µ—Ç–æ–¥—ã:**

```python
# –°–æ–∑–¥–∞–Ω–∏–µ
await PaymentRequestCRUD.create_payment_request(
    session, created_by_id, title, amount, comment, invoice_file_id
)

# –ü–æ–ª—É—á–µ–Ω–∏–µ
await PaymentRequestCRUD.get_payment_request_by_id(session, request_id)
await PaymentRequestCRUD.get_user_payment_requests(session, user_id)
await PaymentRequestCRUD.get_all_payment_requests(session, status=None)
await PaymentRequestCRUD.get_pending_requests(session)

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
await PaymentRequestCRUD.update_payment_request(session, request_id, **kwargs)
await PaymentRequestCRUD.cancel_payment_request(session, request_id)
await PaymentRequestCRUD.mark_as_paid(session, request_id, paid_by_id, payment_proof_file_id)
await PaymentRequestCRUD.schedule_payment(session, request_id, processing_by_id, scheduled_date, is_today)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ message_id
await PaymentRequestCRUD.set_worker_message_id(session, request_id, message_id)
await PaymentRequestCRUD.set_billing_message_id(session, request_id, message_id)
```

## –ö–æ–º–∞–Ω–¥—ã

### `/cancel`

–û—Ç–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é:
- –û—á–∏—â–∞–µ—Ç FSM state (–∑–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–∫–∏, –≤—ã–±–æ—Ä –¥–∞—Ç—ã)
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (APScheduler) ‚úÖ

- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 18:00 –ú–°–ö –¥–ª—è `SCHEDULED_TODAY`
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 10:00 –ú–°–ö –¥–ª—è `SCHEDULED_DATE`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollover –≤ 00:01 –ú–°–ö –µ—Å–ª–∏ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –î–∏–∞–ª–æ–≥–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ‚úÖ

- ‚úÖ `my_payment_requests.py` - Worker –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã
  - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏: –í—Å–µ, –û–∂–∏–¥–∞—é—Ç, –û–ø–ª–∞—á–µ–Ω—ã)
  - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞
  - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω–∏—Ç—å pending –∑–∞–ø—Ä–æ—Å
  - –°–∫–∞—á–∞—Ç—å —Å—á–µ—Ç –∏ –ø–ª–∞—Ç–µ–∂–∫—É

- ‚úÖ `all_payment_requests.py` - Billing –≤–∏–¥–∏—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
  - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏: –í—Å–µ, –û–∂–∏–¥–∞—é—Ç, –û–ø–ª–∞—á–µ–Ω—ã)
  - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞
  - –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–ª—É—á—à–µ–Ω–∏—è

- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å pending –∑–∞–ø—Ä–æ—Å
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É/–∫–∞–Ω–∞–ª
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ–ø–ª–∞—Ç–∞–º

## Scheduler (APScheduler)

### –§–∞–π–ª: `bot/services/scheduler.py`

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown.

**–ó–∞–¥–∞—á–∏:**

1. **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 18:00 –ú–°–ö** (`reminder_scheduled_today`)
   - –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 18:00 –ú–°–ö
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `SCHEDULED_TODAY`
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ billing –∫–æ–Ω—Ç–∞–∫—Ç—É
   - –° inline –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π

2. **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 10:00 –ú–°–ö** (`reminder_scheduled_date`)
   - –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 10:00 –ú–°–ö
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `SCHEDULED_DATE` —Å `scheduled_date == today`
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ billing –∫–æ–Ω—Ç–∞–∫—Ç—É
   - –° inline –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π

3. **Rollover –≤ 00:01 –ú–°–ö** (`rollover_scheduled_today`)
   - –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:01 –ú–°–ö
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `SCHEDULED_TODAY` –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –æ–ø–ª–∞—á–µ–Ω—ã –≤—á–µ—Ä–∞
   - –£–≤–µ–¥–æ–º–ª—è–µ—Ç Worker –∏ billing –∫–æ–Ω—Ç–∞–∫—Ç–∞
   - –ó–∞–ø—Ä–æ—Å –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º (—Å—Ç–∞—Ç—É—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)

### –§–∞–π–ª: `bot/services/payment_reminders.py`

–°–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.

## –î–∏–∞–ª–æ–≥–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

### –ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É (Worker)

**–î–∏–∞–ª–æ–≥:** `MyPaymentRequests` (`bot/dialogs/my_payment_requests.py`)

**–î–æ—Å—Ç—É–ø:** –ö–Ω–æ–ø–∫–∞ "üìù –ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é (–¥–ª—è Worker/Manager/Owner, –ù–ï –¥–ª—è billing –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `list` - –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- `view_details` - –î–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–≤–æ–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –§–∏–ª—å—Ç—Ä—ã: –í—Å–µ, –û–∂–∏–¥–∞—é—Ç, –û–ø–ª–∞—á–µ–Ω—ã
- –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞
- –°–∫–∞—á–∞—Ç—å —Å—á–µ—Ç (–µ—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω)
- –°–∫–∞—á–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∫—É (–µ—Å–ª–∏ –æ–ø–ª–∞—á–µ–Ω–æ)
- –û—Ç–º–µ–Ω–∏—Ç—å pending –∑–∞–ø—Ä–æ—Å

### –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É (Billing)

**–î–∏–∞–ª–æ–≥:** `AllPaymentRequests` (`bot/dialogs/all_payment_requests.py`)

**–î–æ—Å—Ç—É–ø:** –ö–Ω–æ–ø–∫–∞ "üìä –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –¥–ª—è `is_billing_contact=True`)

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `list` - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- `view_details` - –î–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ
- –§–∏–ª—å—Ç—Ä—ã: –í—Å–µ, –û–∂–∏–¥–∞—é—Ç, –û–ø–ª–∞—á–µ–Ω—ã
- –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞
- –°–∫–∞—á–∞—Ç—å —Å—á–µ—Ç –∏ –ø–ª–∞—Ç–µ–∂–∫—É
- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å inline –∫–Ω–æ–ø–∫–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

–ö–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (`bot/dialogs/main_menu.py`):

**–î–ª—è Worker/Manager/Owner (–ù–ï billing –∫–æ–Ω—Ç–∞–∫—Ç—ã):**
- "üí∞ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ–ø–ª–∞—Ç—É" - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- "üìù –ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É" - –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–î–ª—è Billing –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (`is_billing_contact=True`):**
- "üìä –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø–ª–∞—Ç—É" - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ù–ï–¢ –∫–Ω–æ–ø–æ–∫ "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ–ø–ª–∞—Ç—É" –∏ "–ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã" (billing –∫–æ–Ω—Ç–∞–∫—Ç—ã —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã, –Ω–µ —Å–æ–∑–¥–∞—é—Ç)

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

**main.py:**
```python
# –î–∏–∞–ª–æ–≥–∏
dp.include_router(payment_request_creation_dialog)
dp.include_router(my_payment_requests_dialog)
dp.include_router(all_payment_requests_dialog)

# Callback handlers
dp.include_router(payment_callbacks_router)

# Scheduler
start_scheduler(bot)
# ... –ø—Ä–∏ shutdown
shutdown_scheduler()
```

## –§–∞–π–ª—ã

```
bot/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ models.py                      # PaymentRequest, PaymentRequestStatus
‚îÇ   ‚îî‚îÄ‚îÄ crud.py                        # PaymentRequestCRUD
‚îú‚îÄ‚îÄ dialogs/
‚îÇ   ‚îú‚îÄ‚îÄ payment_request.py             # –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ my_payment_requests.py         # –î–∏–∞–ª–æ–≥ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–≤–æ–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (Worker)
‚îÇ   ‚îú‚îÄ‚îÄ all_payment_requests.py        # –î–∏–∞–ª–æ–≥ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (Billing)
‚îÇ   ‚îî‚îÄ‚îÄ main_menu.py                   # –û–±–Ω–æ–≤–ª–µ–Ω: –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ commands.py                    # /cancel —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π FSM
‚îÇ   ‚îî‚îÄ‚îÄ payment_callbacks.py           # Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è billing
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    # –≠–∫—Å–ø–æ—Ä—Ç scheduler
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py                   # APScheduler –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ payment_reminders.py           # –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
‚îî‚îÄ‚îÄ states.py                          # PaymentRequestCreation, MyPaymentRequests, AllPaymentRequests, UploadProof, SelectDate

alembic/versions/
‚îî‚îÄ‚îÄ 20251230_0540-92f0ae364202_add_payment_requests_table.py

main.py                                # –û–±–Ω–æ–≤–ª–µ–Ω: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –∏ scheduler
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- aiogram 3.x
- aiogram-dialog
- SQLAlchemy 2.0 (async)
- PostgreSQL —Å asyncpg
- APScheduler 3.11+ ‚úÖ
- pytz ‚úÖ

## –ú–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head

# –¢–µ–∫—É—â–∞—è —Ä–µ–≤–∏–∑–∏—è
alembic current

# –ò—Å—Ç–æ—Ä–∏—è
alembic history
```

**–¢–µ–∫—É—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:** `92f0ae364202` (add_payment_requests_table)
